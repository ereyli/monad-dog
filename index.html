<!DOCTYPE html>
<html>
<head>
  <link rel="icon" type="image/png" href="https://placedog.net/favicon.ico">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monad Fun Page</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    html {
      box-sizing: border-box;
      font-size: 16px;
    }

    *, *:before, *:after {
      box-sizing: inherit;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #1e003e 0%, #330066 100%);
      color: #ffffff;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background: rgba(44, 0, 105, 0.7);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }
    
    .tabs {
      display: flex;
      justify-content: center;
      background: rgba(44, 0, 105, 0.6);
      border-radius: 12px;
      padding: 5px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    .tab {
      padding: 14px 28px;
      cursor: pointer;
      font-weight: bold;
      border-radius: 8px;
      margin: 0 5px;
      transition: all 0.3s ease;
      text-align: center;
      min-width: 120px;
    }
    
    .tab:hover {
      background: rgba(162, 89, 255, 0.3);
    }
    
    .tab.active {
      background: #a259ff;
      box-shadow: 0 4px 10px rgba(162, 89, 255, 0.5);
    }
    
    .tab-content {
      display: none;
      padding: 30px;
      text-align: center;
      background: rgba(44, 0, 105, 0.5);
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(5px);
      margin-top: 10px;
      animation: fadeIn 0.5s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .tab-content.active {
      display: block;
    }
    
    button {
      font-size: 18px;
      font-weight: 600;
      padding: 12px 30px;
      margin-top: 20px;
      border: none;
      border-radius: 12px;
      background: linear-gradient(135deg, #a259ff 0%, #8338ec 100%);
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(162, 89, 255, 0.5);
    }
    
    button:hover {
      background: linear-gradient(135deg, #b57aff 0%, #9355f5 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(162, 89, 255, 0.6);
    }
    
    button:active {
      transform: translateY(1px);
      box-shadow: 0 2px 8px rgba(162, 89, 255, 0.4);
    }
    
    button:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }
    
    .button-icon {
      margin-right: 8px;
    }
    
    .info {
      margin-top: 20px;
      font-size: 18px;
      color: #eee;
      background: rgba(0, 0, 0, 0.2);
      padding: 15px;
      border-radius: 10px;
      transition: all 0.3s ease;
    }
    
    .xp-box {
      background: linear-gradient(135deg, #a259ff, #8338ec);
      color: white;
      padding: 10px 20px;
      border-radius: 14px;
      font-size: 18px;
      font-weight: bold;
      box-shadow: 0 0 20px rgba(162, 89, 255, 0.5);
      display: flex;
      align-items: center;
      min-width: 140px;
      justify-content: center;
    }
    
    .xp-value {
      margin-left: 8px;
      background: rgba(255, 255, 255, 0.2);
      padding: 3px 8px;
      border-radius: 8px;
    }
    
    .connect-box button {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    h1 {
      font-size: 32px;
      margin-bottom: 30px;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      color: #fff;
    }
    
    #coin {
      font-size: 80px;
      margin: 30px auto;
      transition: transform 0.5s ease;
      display: inline-block;
      text-shadow: 0 0 30px rgba(255, 215, 0, 0.7);
    }
    
    #dogImage {
      max-width: 300px;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
      transition: all 0.3s ease;
      margin-bottom: 20px;
      border: 4px solid rgba(162, 89, 255, 0.5);
    }
    
    #dogImage:hover {
      transform: scale(1.02);
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
    }
    
    .gm-gn-buttons {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
    }
    
    .transaction-status {
      margin-top: 15px;
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s ease;
      display: none;
    }
    
    .transaction-status.visible {
      display: block;
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 0.7; }
      50% { opacity: 1; }
      100% { opacity: 0.7; }
    }
    
    .status-pending {
      background: rgba(255, 166, 0, 0.2);
      border: 1px solid rgba(255, 166, 0, 0.5);
    }
    
    .status-success {
      background: rgba(0, 255, 0, 0.1);
      border: 1px solid rgba(0, 255, 0, 0.3);
    }
    
    .status-error {
      background: rgba(255, 0, 0, 0.1);
      border: 1px solid rgba(255, 0, 0, 0.3);
    }
    
    @media screen and (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 15px;
        padding: 15px;
      }
      
      .tabs {
        flex-wrap: wrap;
      }
      
      .tab {
        min-width: 100px;
        padding: 12px 20px;
        margin-bottom: 5px;
      }
      
      #coin {
        font-size: 60px;
      }
      
      .gm-gn-buttons {
        flex-direction: column;
        gap: 10px;
      }
      
      button {
        width: 100%;
        padding: 15px;
      }
    }
    
    @media screen and (max-width: 480px) {
      .container {
        padding: 10px;
      }
      
      .tab-content {
        padding: 20px 15px;
      }
      
      .xp-box, .connect-box button {
        font-size: 16px;
        padding: 8px 15px;
      }
      
      h1 {
        font-size: 24px;
        margin-bottom: 20px;
      }
      
      #coin {
        font-size: 50px;
      }
      
      #dogImage {
        max-width: 250px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="xp-box">‚ú® XP: <span id="xpCounter" class="xp-value">0</span></div>
      <div class="connect-box">
        <button id="connectBtn"><span class="button-icon">üîå</span> Connect Wallet</button>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" onclick="showTab(event, 'pet-tab')">üê∂ Pet The Dog</div>
      <div class="tab" onclick="showTab(event, 'gmgn-tab')">üåÖ GM / GN</div>
      <div class="tab" onclick="showTab(event, 'flip-tab')">ü™ô Flip Coin</div>
    </div>

    <div id="pet-tab" class="tab-content active">
      <h1>üê∂ Pet The Adorable Dog</h1>
      <img id="dogImage" src="https://placedog.net/400/300?id=7" alt="Cute dog"><br>
      <button onclick="petDog()"><span class="button-icon">üëã</span> Pet Dog</button>
      <div id="petStatus" class="transaction-status status-pending">Transaction in progress...</div>
    </div>

    <div id="gmgn-tab" class="tab-content">
      <h1>üåÖ Good Morning / Good Night</h1>
      <p>Greet the Monad community with GM in the morning or GN in the evening!</p>
      <div class="gm-gn-buttons">
        <button onclick="sayGM()"><span class="button-icon">‚òÄÔ∏è</span> Say GM</button>
        <button onclick="sayGN()"><span class="button-icon">üåô</span> Say GN</button>
      </div>
      <div id="greetStatus" class="transaction-status status-pending">Transaction in progress...</div>
    </div>

    <div id="flip-tab" class="tab-content">
      <h1>ü™ô Flip the Monad Coin</h1>
      <div id="coin">ü™ô</div>
      <button onclick="flipMonad()"><span class="button-icon">üé≤</span> Flip Coin</button>
      <div class="info" id="flipResult">Flip result will appear here</div>
      <div id="flipStatus" class="transaction-status status-pending">Transaction in progress...</div>
    </div>
  </div>

  <script>
    const FLIP_CONTRACT_ADDRESS = "0xc5b2280d1e2f155f9a2be2af7e78190658874106";
    const GREET_CONTRACT_ADDRESS = "0xbc8b78f3e2348d4b5e0390fe700ce54b59931da4";
    const PET_CONTRACT_ADDRESS = "0xc53abe4c593b9440407f8ac1b346f3f999e6d8ed";

    const FLIP_ABI = ["function flip() public"];
    const GREET_ABI = ["function gm() public", "function gn() public"];
    const PET_ABI = ["function pet() public"];

    let provider, signer, userAddress, flipContract;
    let userXP = 0;
    let isConnected = false;

    function disconnect() {
      provider = null;
      signer = null;
      userAddress = null;
      isConnected = false;
      document.getElementById("connectBtn").innerHTML = '<span class="button-icon">üîå</span> Connect Wallet';
    }

    async function handleWalletConnection() {
      if (isConnected) {
        disconnect();
        return;
      }
      await connect();
    }

    async function connect() {
      const MONAD_TESTNET_CHAIN_ID = 10143;
      const targetNetworkName = "Monad Testnet";

      if (!window.ethereum) {
        alert("MetaMask is not installed");
        return;
      }

      try {
        // Request account access
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        
        // Check network
        const network = await provider.getNetwork();
        console.log("Connected to network:", network);
        
        if (network.chainId !== MONAD_TESTNET_CHAIN_ID) {
          try {
            // Try to switch network
            await window.ethereum.request({
              method: 'wallet_switchEthereumChain',
              params: [{ chainId: '0x' + MONAD_TESTNET_CHAIN_ID.toString(16) }],
            });
            
            // Refresh provider after network switch
            provider = new ethers.providers.Web3Provider(window.ethereum);
          } catch (switchError) {
            console.error("Network switch error:", switchError);
            
            // Try to add the network if it doesn't exist
            try {
              await window.ethereum.request({
                method: 'wallet_addEthereumChain',
                params: [{
                  chainId: '0x' + MONAD_TESTNET_CHAIN_ID.toString(16),
                  chainName: 'Monad Testnet',
                  nativeCurrency: {
                    name: 'Monad',
                    symbol: 'MONAD',
                    decimals: 18
                  },
                  rpcUrls: ['https://rpc.monad.xyz/monad-testnet'],
                  blockExplorerUrls: ['https://explorer.monad.xyz/']
                }]
              });
              
              // Refresh provider after network add
              provider = new ethers.providers.Web3Provider(window.ethereum);
            } catch (addError) {
              console.error("Add network error:", addError);
              alert(`Please manually switch to ${targetNetworkName} in your wallet.`);
              return;
            }
          }
        }
        
        // Get signer and address
        signer = provider.getSigner();
        userAddress = await signer.getAddress();
        console.log("Connected to address:", userAddress);
        
        // Initialize contracts with this signer
        flipContract = new ethers.Contract(FLIP_CONTRACT_ADDRESS, FLIP_ABI, signer);
        
        // Update button and status
        isConnected = true;
        document.getElementById("connectBtn").innerHTML = `<span class="button-icon">üü¢</span> ${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
        
        // Log gas price for debugging
        const gasPrice = await provider.getGasPrice();
        console.log("Current gas price:", ethers.utils.formatUnits(gasPrice, "gwei"), "gwei");
        
        // Show successful connection
        console.log("Wallet connected successfully!");
      } catch (error) {
        console.error("Connection error:", error);
        alert("Wallet connection failed: " + (error.message || "Unknown error"));
      }
    }

    function addXP(amount) {
      userXP += amount;
      document.getElementById("xpCounter").innerText = userXP;
    }

    function showTab(event, id) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      event.target.classList.add('active');
      document.getElementById(id).classList.add('active');
    }

    async function flipMonad() {
      if (!isConnected) {
        alert("Connect wallet first");
        return;
      }
      
      const coin = document.getElementById("coin");
      const statusEl = document.getElementById("flipStatus");
      
      let spin = 0;
      document.getElementById("flipResult").innerText = "Flipping...";
      
      // Show pending status
      statusEl.textContent = "Transaction pending...";
      statusEl.className = "transaction-status status-pending visible";
      
      const spinning = setInterval(() => {
        spin += 36;
        coin.style.transform = `rotateY(${spin}deg)`;
      }, 100);
      
      try {
        // Re-create contract with current signer to ensure it's properly connected
        const flipContract = new ethers.Contract(FLIP_CONTRACT_ADDRESS, FLIP_ABI, signer);
        
        // Set gas limit explicitly
        const tx = await flipContract.flip({ 
          gasLimit: 1000000  // Explicitly set higher gas limit
        });
        
        // Show transaction hash
        console.log("Transaction hash:", tx.hash);
        statusEl.textContent = `Processing: ${tx.hash.slice(0,10)}...${tx.hash.slice(-6)}`;
        
        await tx.wait();
        clearInterval(spinning);
        
        const result = Math.random() < 0.5 ? "Heads" : "Tails";
        coin.style.transform = `rotateY(${result === "Heads" ? 0 : 180}deg)`;
        document.getElementById("flipResult").innerText = `‚úÖ Flip result: ${result}`;
        
        // Show success status
        statusEl.textContent = "Transaction successful!";
        statusEl.className = "transaction-status status-success visible";
        setTimeout(() => {
          statusEl.className = "transaction-status";
        }, 3000);
        
        addXP(3);
      } catch (e) {
        clearInterval(spinning);
        console.error("Flip error:", e);
        document.getElementById("flipResult").innerText = `‚ùå Flip failed: ${e.message ? e.message.slice(0, 50) : "Unknown error"}`;
        
        // Show error status
        statusEl.textContent = `Error: ${e.message ? e.message.slice(0, 50) : "Unknown error"}`;
        statusEl.className = "transaction-status status-error visible";
        setTimeout(() => {
          statusEl.className = "transaction-status";
        }, 5000);
      }
    }

    async function petDog() {
      if (!isConnected) {
        alert("Connect wallet first");
        return;
      }
      
      const dogImage = document.getElementById('dogImage');
      const statusEl = document.getElementById("petStatus");
      
      // Show a new random dog
      dogImage.src = `https://placedog.net/400/300?id=${Math.floor(Math.random() * 50) + 1}`;
      
      // Show pending status
      statusEl.textContent = "Petting in progress...";
      statusEl.className = "transaction-status status-pending visible";
      
      try {
        // Re-create contract with current signer to ensure it's properly connected
        const petContract = new ethers.Contract(PET_CONTRACT_ADDRESS, PET_ABI, signer);
        
        // Set gas limit explicitly
        const tx = await petContract.pet({ 
          gasLimit: 1000000  // Explicitly set higher gas limit
        });
        
        // Show transaction hash
        console.log("Pet transaction hash:", tx.hash);
        statusEl.textContent = `Processing: ${tx.hash.slice(0,10)}...${tx.hash.slice(-6)}`;
        
        await tx.wait();
        
        // Show success status
        statusEl.textContent = "Dog successfully petted! üê∂";
        statusEl.className = "transaction-status status-success visible";
        setTimeout(() => {
          statusEl.className = "transaction-status";
        }, 3000);
        
        addXP(10);
      } catch (e) {
        console.error("Pet error:", e);
        
        // Show error status
        statusEl.textContent = `Error: ${e.message ? e.message.slice(0, 50) : "Unknown error"}`;
        statusEl.className = "transaction-status status-error visible";
        setTimeout(() => {
          statusEl.className = "transaction-status";
        }, 5000);
      }
    }

    async function sayGM() {
      if (!isConnected) {
        alert("Connect wallet first");
        return;
      }
      
      const statusEl = document.getElementById("greetStatus");
      const buttonSpan = document.querySelector('button[onclick="sayGM()"] .button-icon');
      
      // Update button appearance
      document.querySelector('button[onclick="sayGM()"]').disabled = true;
      buttonSpan.textContent = "‚è≥";
      
      // Show pending status
      statusEl.textContent = "Sending GM to the blockchain...";
      statusEl.className = "transaction-status status-pending visible";
      
      try {
        // Re-create contract with current signer to ensure it's properly connected
        const greetContract = new ethers.Contract(GREET_CONTRACT_ADDRESS, GREET_ABI, signer);
        
        // Set gas limit explicitly
        const tx = await greetContract.gm({ 
          gasLimit: 1000000  // Explicitly set higher gas limit
        });
        
        // Show transaction hash
        console.log("GM transaction hash:", tx.hash);
        statusEl.textContent = `Processing: ${tx.hash.slice(0,10)}...${tx.hash.slice(-6)}`;
        
        await tx.wait();
        
        // Update button appearance
        buttonSpan.textContent = "‚úÖ";
        setTimeout(() => {
          buttonSpan.textContent = "‚òÄÔ∏è";
          document.querySelector('button[onclick="sayGM()"]').disabled = false;
        }, 3000);
        
        // Show success status
        statusEl.textContent = "GM successfully sent to the community!";
        statusEl.className = "transaction-status status-success visible";
        setTimeout(() => {
          statusEl.className = "transaction-status";
        }, 3000);
        
        addXP(5);
      } catch (e) {
        // Update button appearance
        buttonSpan.textContent = "‚ùå";
        setTimeout(() => {
          buttonSpan.textContent = "‚òÄÔ∏è";
          document.querySelector('button[onclick="sayGM()"]').disabled = false;
        }, 3000);
        
        console.error("GM error:", e);
        
        // Show error status
        statusEl.textContent = `Error: ${e.message ? e.message.slice(0, 50) : "Unknown error"}`;
        statusEl.className = "transaction-status status-error visible";
        setTimeout(() => {
          statusEl.className = "transaction-status";
        }, 5000);
      }
    }

    async function sayGN() {
      if (!isConnected) {
        alert("Connect wallet first");
        return;
      }
      
      const statusEl = document.getElementById("greetStatus");
      const buttonSpan = document.querySelector('button[onclick="sayGN()"] .button-icon');
      
      // Update button appearance
      document.querySelector('button[onclick="sayGN()"]').disabled = true;
      buttonSpan.textContent = "‚è≥";
      
      // Show pending status
      statusEl.textContent = "Sending GN to the blockchain...";
      statusEl.className = "transaction-status status-pending visible";
      
      try {
        // Re-create contract with current signer to ensure it's properly connected
        const greetContract = new ethers.Contract(GREET_CONTRACT_ADDRESS, GREET_ABI, signer);
        
        // Set gas limit explicitly
        const tx = await greetContract.gn({ 
          gasLimit: 1000000  // Explicitly set higher gas limit
        });
        
        // Show transaction hash
        console.log("GN transaction hash:", tx.hash);
        statusEl.textContent = `Processing: ${tx.hash.slice(0,10)}...${tx.hash.slice(-6)}`;
        
        await tx.wait();
        
        // Update button appearance
        buttonSpan.textContent = "‚úÖ";
        setTimeout(() => {
          buttonSpan.textContent = "üåô";
          document.querySelector('button[onclick="sayGN()"]').disabled = false;
        }, 3000);
        
        // Show success status
        statusEl.textContent = "GN successfully sent to the community!";
        statusEl.className = "transaction-status status-success visible";
        setTimeout(() => {
          statusEl.className = "transaction-status";
        }, 3000);
        
        addXP(5);
      } catch (e) {
        // Update button appearance
        buttonSpan.textContent = "‚ùå";
        setTimeout(() => {
          buttonSpan.textContent = "üåô";
          document.querySelector('button[onclick="sayGN()"]').disabled = false;
        }, 3000);
        
        console.error("GN error:", e);
        
        // Show error status
        statusEl.textContent = `Error: ${e.message ? e.message.slice(0, 50) : "Unknown error"}`;
        statusEl.className = "transaction-status status-error visible";
        setTimeout(() => {
          statusEl.className = "transaction-status";
        }, 5000);
      }
    }

    // Initialize when DOM is loaded
    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById("connectBtn").onclick = handleWalletConnection;
    });
  </script>
</body>
</html>
