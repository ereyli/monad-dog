<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monad Dog</title>

  <!-- Supabase Client -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  
  <!-- Farcaster Manifest Link -->
  <link rel="manifest" href="/farcaster.json">
  <link rel="icon" type="image/png" href="https://monad-snowy.vercel.app/.well-known/icon.png">
  
  <!-- Farcaster Meta with Dynamic Content -->
  <meta name="fc:frame" content='{
    "version": "next",
    "imageUrl": "https://monad-snowy.vercel.app/.well-known/share.png",
    "button": {
      "title": "🐕 Play Monad Dog",
      "action": {
        "type": "launch_frame",
        "url": "https://monad-snowy.vercel.app",
        "name": "Monad Dog",
        "splashImageUrl": "https://monad-snowy.vercel.app/.well-known/icon.png",
        "splashBackgroundColor": "#1e003e"
      }
    }
  }' />

  <!-- Open Graph for better sharing -->
  <meta property="og:title" content="Monad Dog - Pet, Greet, Flip on Monad Testnet" />
  <meta property="og:description" content="Interactive Farcaster Mini App on Monad Testnet. Pet the dog, say GM/GN, flip coins and earn XP!" />
  <meta property="og:image" content="https://monad-snowy.vercel.app/.well-known/share.png" />
  <meta property="og:url" content="https://monad-snowy.vercel.app" />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Monad Dog - Pet, Greet, Flip on Monad Testnet" />
  <meta name="twitter:description" content="Interactive Farcaster Mini App on Monad Testnet. Pet the dog, say GM/GN, flip coins and earn XP!" />
  <meta name="twitter:image" content="https://monad-snowy.vercel.app/.well-known/share.png" />

  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  
  <!-- Farcaster Mini App SDK -->
  <script type="module">
    import { sdk } from 'https://esm.sh/@farcaster/frame-sdk';
    
    // Mini App ready when loaded
    window.addEventListener('load', async () => {
      try {
        await sdk.actions.ready();
        console.log('Farcaster Mini App ready!');
        
        // Make SDK available globally
        window.farcasterSDK = sdk;
      } catch (error) {
        console.log('Not running in Farcaster client:', error);
      }
    });
  </script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #1e003e 0%, #330066 100%);
      color: white;
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 400px;
      margin: 0 auto;
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .title {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    
    .social-link {
      background: rgba(255,255,255,0.1);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      transition: all 0.3s ease;
      margin-top: 15px;
    }
    
    .social-link:hover {
      background: rgba(255,255,255,0.2);
      transform: scale(1.1);
    }
    
    .social-link svg {
      width: 20px;
      height: 20px;
      fill: white;
    }
    
    .xp {
      background: rgba(255,255,255,0.1);
      padding: 10px 20px;
      border-radius: 20px;
      display: inline-block;
      margin-bottom: 20px;
    }
    
    .wallet-section {
      background: rgba(255,255,255,0.1);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      text-align: center;
    }
    
    button {
      background: #6366f1;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      width: 100%;
      margin: 10px 0;
    }
    
    button:hover {
      background: #5855e8;
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .tabs {
      display: flex;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
      margin-bottom: 20px;
      overflow: hidden;
    }
    
    .tab {
      flex: 1;
      padding: 12px;
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 14px;
    }
    
    .tab.active {
      background: #6366f1;
    }
    
    .content {
      background: rgba(255,255,255,0.1);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      min-height: 200px;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .dog-image {
      width: 200px;
      height: 200px;
      border-radius: 12px;
      margin: 20px auto;
      display: block;
    }
    
    .coin {
      font-size: 60px;
      margin: 20px;
      transition: transform 0.5s;
    }
    
    .status {
      margin-top: 15px;
      padding: 10px;
      border-radius: 8px;
      display: none;
    }
    
    .status.visible {
      display: block;
    }
    
    .status.success {
      background: rgba(0,255,0,0.2);
      color: #00ff00;
    }
    
    .status.error {
      background: rgba(255,0,0,0.2);
      color: #ff6b6b;
    }
    
    .status.pending {
      background: rgba(255,255,0,0.2);
      color: #ffeb3b;
    }
    
    .loading {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #1e003e 0%, #330066 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      color: white;
    }

    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255,255,255,0.2);
      border-radius: 50%;
      border-top-color: #6366f1;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    .loading-text {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      animation: pulse 2s ease-in-out infinite;
    }

    .loading-subtitle {
      font-size: 14px;
      opacity: 0.7;
      text-align: center;
      max-width: 280px;
      line-height: 1.4;
    }

    .loading-progress {
      width: 200px;
      height: 4px;
      background: rgba(255,255,255,0.2);
      border-radius: 2px;
      margin-top: 20px;
      overflow: hidden;
    }

    .loading-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #6366f1, #8b5cf6);
      border-radius: 2px;
      width: 0%;
      transition: width 0.3s ease;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    /* Skeleton Loading States */
    .skeleton {
      background: linear-gradient(90deg, rgba(255,255,255,0.1) 25%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0.1) 75%);
      background-size: 200% 100%;
      animation: skeleton-loading 1.5s infinite;
    }

    @keyframes skeleton-loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .skeleton-text {
      height: 16px;
      border-radius: 4px;
      margin: 8px 0;
    }

    .skeleton-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
    }

    .skeleton-button {
      height: 44px;
      border-radius: 8px;
      margin: 10px 0;
    }

    /* Hide content initially to prevent layout shift */
    .app-content {
      opacity: 0;
      transition: opacity 0.5s ease;
    }

    .app-content.loaded {
      opacity: 1;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    
    th, td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }
    
    th {
      background: rgba(255,255,255,0.1);
    }
    
    .address {
      font-family: monospace;
      font-size: 12px;
    }

    .badge {
      background: #ff6b9d;
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 500;
      margin-left: 8px;
    }

    .rank-number {
      font-weight: 600;
      color: #6366f1;
      width: 40px;
    }

    .address-cell {
      font-family: monospace;
      font-size: 12px;
    }

    .share-button {
      background: linear-gradient(45deg, #6366f1, #8b5cf6);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin: 10px 5px;
      width: auto;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
    }

    .share-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(99, 102, 241, 0.4);
    }

    .share-section {
      text-align: center;
      margin-top: 20px;
      padding: 15px;
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .achievement-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.3s ease;
    }

    .achievement-content {
      background: linear-gradient(135deg, #1e003e 0%, #330066 100%);
      padding: 30px;
      border-radius: 20px;
      text-align: center;
      max-width: 350px;
      border: 2px solid #6366f1;
      box-shadow: 0 20px 40px rgba(0,0,0,0.5);
    }

    .achievement-icon {
      font-size: 60px;
      margin-bottom: 15px;
      animation: bounce 0.6s ease;
    }

    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-10px); }
      60% { transform: translateY(-5px); }
    }

    .close-modal {
      position: absolute;
      top: 10px;
      right: 15px;
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      width: auto;
      padding: 5px;
      opacity: 0.8;
      transition: opacity 0.2s;
    }
    
    .close-modal:hover {
      opacity: 1;
    }

    /* Token Claim Styles */
    .token-stats {
      background: linear-gradient(135deg, #f59e0b, #eab308);
      padding: 8px 16px;
      border-radius: 20px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-left: 10px;
      font-size: 14px;
      font-weight: 600;
    }

    .claim-section {
      background: rgba(255,255,255,0.1);
      padding: 20px;
      border-radius: 12px;
      margin-top: 20px;
      border: 1px solid rgba(255,255,255,0.2);
    }

    .claim-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .claim-info-item {
      text-align: center;
    }

    .claim-info-label {
      font-size: 12px;
      opacity: 0.7;
      margin-bottom: 5px;
    }

    .claim-info-value {
      font-size: 20px;
      font-weight: 600;
      color: #f59e0b;
    }

    .claim-button {
      background: linear-gradient(135deg, #f59e0b, #eab308);
      color: white;
      font-weight: 600;
      padding: 14px 28px;
      border-radius: 12px;
      width: 100%;
      margin-top: 10px;
      transition: all 0.3s ease;
    }

    .claim-button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(245, 158, 11, 0.4);
    }

    .claim-button:disabled {
      background: rgba(255,255,255,0.1);
      cursor: not-allowed;
    }

    .token-balance {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
      padding: 10px;
      background: rgba(245, 158, 11, 0.1);
      border-radius: 8px;
      font-size: 14px;
    }

    .conversion-rate {
      text-align: center;
      font-size: 12px;
      opacity: 0.7;
      margin-top: 8px;
    }

    .claim-history {
      margin-top: 20px;
      font-size: 12px;
      opacity: 0.7;
    }

    .claim-history-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    /* Slots Machine Styles */
    .slots-machine {
      background: rgba(255,255,255,0.1);
      padding: 25px;
      border-radius: 16px;
      margin: 20px 0;
      border: 2px solid rgba(255,255,255,0.2);
    }

    .slots-display {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 25px 0;
      padding: 20px;
      background: rgba(0,0,0,0.3);
      border-radius: 12px;
      border: 2px solid #6366f1;
    }

    .slot-reel {
      width: 70px;
      height: 70px;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      border: 2px solid rgba(255,255,255,0.3);
      transition: all 0.3s ease;
    }

    .slot-reel.spinning {
      animation: spin-reel 0.1s linear infinite;
    }

    .slot-reel.winning {
      background: rgba(16, 185, 129, 0.3);
      border-color: #10b981;
      box-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
    }

    @keyframes spin-reel {
      0% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
      100% { transform: translateY(0); }
    }

    .slots-info {
      display: flex;
      justify-content: space-between;
      margin: 15px 0;
      padding: 10px;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
    }

    .slots-button {
      background: linear-gradient(135deg, #f59e0b, #eab308);
      color: white;
      font-weight: 600;
      padding: 16px 32px;
      border-radius: 12px;
      width: 100%;
      margin: 15px 0;
      font-size: 18px;
      transition: all 0.3s ease;
    }

    .slots-button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(245, 158, 11, 0.4);
    }

    .slots-button:disabled {
      background: rgba(255,255,255,0.1);
      cursor: not-allowed;
      transform: none;
    }

    .slots-legend {
      margin-top: 20px;
      padding: 15px;
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
    }

    .symbol-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 10px;
    }

    .symbol-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
    }

    .symbol {
      font-size: 24px;
    }

    .symbol-name {
      font-size: 14px;
      opacity: 0.8;
    }

    .slots-jackpot {
      background: linear-gradient(135deg, #ffd700, #ffed4a);
      color: #1a1a1a;
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
      text-align: center;
      font-weight: 600;
      animation: jackpot-glow 2s ease-in-out infinite;
    }

    @keyframes jackpot-glow {
      0%, 100% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.3); }
      50% { box-shadow: 0 0 30px rgba(255, 215, 0, 0.6); }
    }
  </style>
</head>
<body>
  <div class="container app-content">
    <div class="header">
      <div class="title">🐕 Monad Dog</div>
      <div class="xp">✨ Available XP: <span id="xp">0</span></div>
      
      <a href="https://x.com/monaddogg" target="_blank" class="social-link" title="Follow us on Twitter">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
        </svg>
      </a>
    </div>

    <div class="wallet-section">
      <div id="connect-area">
        <button id="connect-btn">🟣 Connect Wallet</button>
      </div>
      <div id="connected-area" style="display: none;">
        <div>🟣 Connected</div>
        <div id="address" class="address"></div>
        <button id="disconnect-btn">Disconnect</button>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="showTab('pet')">🐕 Pet</button>
      <button class="tab" onclick="showTab('greet')">👋 Greet</button>
      <button class="tab" onclick="showTab('flip')">🪙 Flip</button>
      <button class="tab" onclick="showTab('slots')">🎰 Slots</button>
      <button class="tab" onclick="showTab('claim')">💰 Claim</button>
    </div>

    <div class="content">
      <!-- Pet Tab -->
      <div id="pet" class="tab-content active">
        <h3>Pet the Dog</h3>
        <img id="dog-img" class="dog-image" src="https://placedog.net/400/300?id=7" alt="Dog">
        <button onclick="petDog()">👋 Pet Dog (+10 XP)</button>
        <div id="pet-status" class="status"></div>
      </div>

      <!-- Greet Tab -->
      <div id="greet" class="tab-content">
        <h3>Greet Community</h3>
        <p>Say GM or GN to the community!</p>
        <button onclick="sayGM()">☀️ Good Morning (+5 XP)</button>
        <button onclick="sayGN()">🌙 Good Night (+5 XP)</button>
        <div id="greet-status" class="status"></div>
      </div>

      <!-- Flip Tab -->
      <div id="flip" class="tab-content">
        <h3>Flip Coin</h3>
        <div class="coin" id="coin">🪙</div>
        <button onclick="flipCoin()">🎲 Flip Coin (+3 XP)</button>
        <div id="flip-result">Result will appear here</div>
        <div id="flip-status" class="status"></div>
      </div>

      <!-- Slots Tab -->
      <div id="slots" class="tab-content">
        <h3>🎰 Dog Slots</h3>
        <p style="margin-bottom: 20px;">Match 4 same dogs or bones to win 5000 XP!</p>
        
        <div class="slots-machine">
          <div class="slots-display">
            <div class="slot-reel" id="reel1">🐕</div>
            <div class="slot-reel" id="reel2">🦮</div>
            <div class="slot-reel" id="reel3">🐶</div>
            <div class="slot-reel" id="reel4">🦴</div>
          </div>
          
          <div class="slots-info">
            <div class="cost-info">
              <span style="color: #f59e0b;">💰 Pay: 0.1 MONAD = 2 Credits</span>
            </div>
            <div class="prize-info">
              <span style="color: #10b981;">🏆 4 Match = 5000 XP</span>
            </div>
          </div>
          
          <button class="slots-button" id="slotsButton" onclick="playSlots()">
            🔒 Connect Wallet
          </button>
          
          <div id="slots-status" class="status"></div>
        </div>
      </div>

      <!-- Claim Tab -->
      <div id="claim" class="tab-content">
        <h3>Claim $DOG Tokens</h3>
        <p style="margin-bottom: 20px;">Convert your earned XP to $DOG tokens!</p>
        
        <div class="claim-section">
          <div class="claim-info">
            <div class="claim-info-item">
              <div class="claim-info-label">Available XP</div>
              <div class="claim-info-value" id="claimableXP">0</div>
            </div>
            <div class="claim-info-item">
              <div class="claim-info-label">→</div>
              <div style="font-size: 30px;">🔄</div>
            </div>
            <div class="claim-info-item">
              <div class="claim-info-label">$DOG Tokens</div>
              <div class="claim-info-value" id="claimableDOG">0</div>
            </div>
          </div>
          
          <button class="claim-button" id="claimButton" onclick="claimTokens()" disabled>
            💰 Claim $DOG Tokens
          </button>
          
          <div id="claim-status" class="status"></div>
        </div>
        
        <!-- Token Info -->
        <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 12px;">
          <div style="text-align: center; margin-bottom: 15px;">
            <h4 style="margin-bottom: 10px;">🐕 $DOG Token Info</h4>
          </div>
          
          <!-- Wallet DOG Balance Display -->
          <div style="background: linear-gradient(135deg, #f59e0b, #eab308); padding: 20px; border-radius: 12px; text-align: center; margin: 15px 0;">
            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">Your Wallet Balance</div>
            <div style="font-size: 32px; font-weight: 700;">
              <span id="walletDogDisplay">0</span> $DOG
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="loading" class="loading">
      <div class="loading-spinner"></div>
      <div class="loading-text">Loading Monad Dog...</div>
      <div class="loading-subtitle">Starting Monad Dog...<br>🚀 Initializing blockchain connection</div>
      <div class="loading-progress">
        <div class="loading-progress-bar" id="loadingProgressBar"></div>
      </div>
    </div>
  </div>

  <script>
    // Wait for everything to be ready
    window.addEventListener('DOMContentLoaded', function() {
      console.log('🚀 Starting app...');

      // Contract addresses and ABIs
      const CONTRACTS = {
        PET: "0xc53abe4c593b9440407f8ac1b346f3f999e6d8ed",
        GREET: "0xbc8b78f3e2348d4b5e0390fe700ce54b59931da4",
        FLIP: "0xc5b2280d1e2f155f9a2be2af7e78190658874106",
        SLOTS: "0x6e9a2fcf69a16f6bbfae21261f6ccc023fbda549",
        DOG_TOKEN: "0x1f6649d028c4c146c050a9b224115a01c92a02f3"
      };

      const ABIS = {
        PET: ["function pet() public"],
        GREET: ["function gm() public", "function gn() public"],
        FLIP: ["function flip() public"],
        SLOTS: [
          "function buyCredits() external payable",
          "function playSlots() external returns (uint8[4])",
          "function getCredits(address player) external view returns (uint256)"
        ],
        DOG_TOKEN: [
          "function claim(uint256 xpAmount) public",
          "function balanceOf(address account) public view returns (uint256)",
          "function decimals() public view returns (uint8)"
        ]
      };

      // Global state
      let appState = {
        connected: false,
        address: null,
        xp: 0,
        slotsCredits: 0,
        provider: null,
        signer: null,
        isTransactionPending: false
      };

      let sdk = window.farcasterSDK || null;
      let activeTab = 'pet';
      let isAppReady = false;

      // Initialize app
      async function initApp() {
        try {
          console.log('Initializing app...');
          showLoadingState();
          
          // Setup event listeners
          setupEventListeners();
          setupGameFunctions();
          
          // Hide loading after a short delay
          setTimeout(() => {
            hideLoadingState();
            console.log('✅ App initialized');
          }, 1000);
          
        } catch (error) {
          console.error('Init error:', error);
          hideLoadingState();
        }
      }

      function showLoadingState() {
        document.getElementById('loading').style.display = 'flex';
        document.querySelector('.app-content').classList.remove('loaded');
      }

      function hideLoadingState() {
        document.getElementById('loading').style.display = 'none';
        document.querySelector('.app-content').classList.add('loaded');
        isAppReady = true;
      }

      function setupEventListeners() {
        document.getElementById('connect-btn').onclick = connectWallet;
        document.getElementById('disconnect-btn').onclick = disconnect;
      }

      // Setup all game functions
      function setupGameFunctions() {
        // Pet Dog function
        window.petDog = async function() {
          console.log('🐕 Pet Dog clicked!');
          
          if (!appState.connected) {
            showError('Connect wallet first');
            return;
          }
          
          if (appState.isTransactionPending) {
            showError('Please wait for the current transaction to complete');
            return;
          }
          
          // Change dog image
          document.getElementById('dog-img').src = `https://placedog.net/400/300?id=${Math.floor(Math.random() * 50) + 1}`;
          
          // Execute transaction
          await executeTransaction(
            CONTRACTS.PET,
            ABIS.PET,
            'pet',
            'pet-status',
            '🐕 Dog petted successfully! +10 XP',
            10
          );
        };

        // Say GM function
        window.sayGM = async function() {
          console.log('☀️ Say GM clicked!');
          
          if (!appState.connected) {
            showError('Connect wallet first');
            return;
          }
          
          if (appState.isTransactionPending) {
            showError('Please wait for the current transaction to complete');
            return;
          }
          
          await executeTransaction(
            CONTRACTS.GREET,
            ABIS.GREET,
            'gm',
            'greet-status',
            '☀️ Good Morning sent! +5 XP',
            5
          );
        };

        // Say GN function
        window.sayGN = async function() {
          console.log('🌙 Say GN clicked!');
          
          if (!appState.connected) {
            showError('Connect wallet first');
            return;
          }
          
          if (appState.isTransactionPending) {
            showError('Please wait for the current transaction to complete');
            return;
          }
          
          await executeTransaction(
            CONTRACTS.GREET,
            ABIS.GREET,
            'gn',
            'greet-status',
            '🌙 Good Night sent! +5 XP',
            5
          );
        };

        // Flip Coin function
        window.flipCoin = async function() {
          console.log('🪙 Flip Coin clicked!');
          
          if (!appState.connected) {
            showError('Connect wallet first');
            return;
          }
          
          if (appState.isTransactionPending) {
            showError('Please wait for the current transaction to complete');
            return;
          }
          
          const coin = document.getElementById('coin');
          const result = document.getElementById('flip-result');
          
          // Start animation
          result.textContent = 'Flipping...';
          let rotation = 0;
          const interval = setInterval(() => {
            rotation += 180;
            coin.style.transform = `rotateY(${rotation}deg)`;
          }, 100);
          
          // Execute transaction
          await executeTransaction(
            CONTRACTS.FLIP,
            ABIS.FLIP,
            'flip',
            'flip-status',
            '🪙 Coin flipped! +3 XP',
            3
          );
          
          // Stop animation after transaction
          setTimeout(() => {
            clearInterval(interval);
            const finalResult = Math.random() < 0.5 ? 'Heads' : 'Tails';
            coin.style.transform = `rotateY(${finalResult === 'Heads' ? 0 : 180}deg)`;
            result.textContent = `Result: ${finalResult}!`;
          }, 3000);
        };

        // Play Slots function
        window.playSlots = async function() {
          console.log('🎰 Play Slots clicked!');
          
          if (!appState.connected) {
            showError('Connect wallet first');
            return;
          }
          
          if (appState.isTransactionPending) {
            showError('Please wait for the current transaction to complete');
            return;
          }
          
          // For now, just show a message
          showStatus('slots-status', '🎰 Slots coming soon!', 'pending');
          setTimeout(() => hideStatus('slots-status'), 3000);
        };

        // Claim Tokens function
        window.claimTokens = async function() {
          console.log('💰 Claim Tokens clicked!');
          
          if (!appState.connected) {
            showError('Connect wallet first');
            return;
          }
          
          if (appState.isTransactionPending) {
            showError('Please wait for the current transaction to complete');
            return;
          }
          
          // For now, just show a message
          showStatus('claim-status', '💰 Claim feature coming soon!', 'pending');
          setTimeout(() => hideStatus('claim-status'), 3000);
        };

        // Show Tab function
        window.showTab = function(tabName) {
          console.log('📑 Switching to tab:', tabName);
          activeTab = tabName;
          
          // Update tabs
          document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
          });
          event.target.classList.add('active');
          
          // Update content
          document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
          });
          document.getElementById(tabName).classList.add('active');
          
          // Update UI if needed
          if (tabName === 'claim') {
            updateClaimUI();
          }
        };
      }

      // Connect wallet with better error handling
      async function connectWallet() {
        try {
          console.log('🔌 Connecting wallet...');
          
          const connectBtn = document.getElementById('connect-btn');
          connectBtn.textContent = '🔄 Connecting...';
          connectBtn.disabled = true;
          
          let provider;
          
          // Check for wallet providers
          if (sdk && sdk.wallet && sdk.wallet.ethProvider) {
            console.log('Using Farcaster wallet');
            provider = sdk.wallet.ethProvider;
          } else if (window.ethereum) {
            console.log('Using browser wallet');
            provider = window.ethereum;
          } else {
            throw new Error('No wallet available');
          }

          // Request accounts
          const accounts = await provider.request({
            method: 'eth_requestAccounts'
          });

          if (!accounts || accounts.length === 0) {
            throw new Error('No accounts found');
          }

          console.log('✅ Connected:', accounts[0]);

          // Setup ethers with correct provider
          appState.provider = new ethers.providers.Web3Provider(provider);
          appState.signer = appState.provider.getSigner();
          appState.address = accounts[0];
          appState.connected = true;

          // Update UI
          updateWalletUI();
          updateXPDisplay();
          
          // Ensure correct network
          await ensureMonadNetwork();

        } catch (error) {
          console.error('❌ Connection error:', error);
          
          let errorMsg = 'Failed to connect wallet';
          if (error.message.includes('User rejected')) {
            errorMsg = 'Connection rejected by user';
          } else if (error.message.includes('No wallet')) {
            errorMsg = 'No wallet found. Please install MetaMask or use Farcaster app';
          }
          
          showError(errorMsg);
          
          // Reset button
          const connectBtn = document.getElementById('connect-btn');
          connectBtn.textContent = '🟣 Connect Wallet';
          connectBtn.disabled = false;
        }
      }

      // Disconnect wallet
      async function disconnect() {
        appState = {
          connected: false,
          address: null,
          xp: 0,
          slotsCredits: 0,
          provider: null,
          signer: null,
          isTransactionPending: false
        };
        
        updateWalletUI();
        updateXPDisplay();
        updateClaimUI();
        
        console.log('🔌 Wallet disconnected');
      }

      // Update wallet UI
      function updateWalletUI() {
        const connectArea = document.getElementById('connect-area');
        const connectedArea = document.getElementById('connected-area');
        const addressEl = document.getElementById('address');

        if (appState.connected) {
          connectArea.style.display = 'none';
          connectedArea.style.display = 'block';
          addressEl.textContent = appState.address.slice(0,6) + '...' + appState.address.slice(-4);
        } else {
          connectArea.style.display = 'block';
          connectedArea.style.display = 'none';
        }
      }

      // Update XP display
      function updateXPDisplay() {
        // For demo purposes, use localStorage
        if (appState.connected && appState.address) {
          const savedXP = localStorage.getItem(`xp_${appState.address.toLowerCase()}`);
          appState.xp = parseInt(savedXP || '0');
        } else {
          appState.xp = 0;
        }
        
        document.getElementById('xp').textContent = appState.xp;
        
        if (activeTab === 'claim') {
          updateClaimUI();
        }
      }

      // Update claim UI
      function updateClaimUI() {
        const claimableXP = appState.xp || 0;
        const claimableDOG = Math.floor(claimableXP / 10); // 10 XP = 1 DOG
        
        document.getElementById('claimableXP').textContent = claimableXP;
        document.getElementById('claimableDOG').textContent = claimableDOG;
        
        const claimButton = document.getElementById('claimButton');
        if (claimableXP >= 10 && appState.connected) {
          claimButton.disabled = false;
          claimButton.textContent = `💰 Claim ${claimableDOG} $DOG Tokens`;
        } else {
          claimButton.disabled = true;
          if (!appState.connected) {
            claimButton.textContent = '🔒 Connect Wallet First';
          } else if (claimableXP < 10) {
            claimButton.textContent = `📈 Need ${10 - claimableXP} more XP`;
          }
        }
      }

      // Add XP
      function addXP(amount) {
        if (!appState.connected || !appState.address) return;
        
        appState.xp += amount;
        localStorage.setItem(`xp_${appState.address.toLowerCase()}`, appState.xp.toString());
        
        // Update display with animation
        const xpElement = document.getElementById('xp');
        xpElement.textContent = appState.xp;
        xpElement.style.transform = 'scale(1.2)';
        xpElement.style.color = '#00ff00';
        
        setTimeout(() => {
          xpElement.style.transform = 'scale(1)';
          xpElement.style.color = 'white';
        }, 500);
        
        if (activeTab === 'claim') {
          updateClaimUI();
        }
      }

      // Show status message
      function showStatus(id, message, type) {
        const el = document.getElementById(id);
        el.textContent = message;
        el.className = `status visible ${type}`;
      }

      // Hide status message
      function hideStatus(id) {
        const el = document.getElementById(id);
        el.className = 'status';
      }

      // Show error message
      function showError(message) {
        const div = document.createElement('div');
        div.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:rgba(255,0,0,0.9);color:white;padding:10px 20px;border-radius:8px;z-index:1000;';
        div.textContent = message;
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 5000);
      }

      // Execute transaction with proper error handling
      async function executeTransaction(contractAddress, abi, methodName, statusId, successMsg, xpAmount) {
        if (!appState.connected || !appState.signer) {
          showError('Wallet not connected');
          return;
        }

        if (appState.isTransactionPending) {
          showError('Transaction already in progress');
          return;
        }

        try {
          console.log(`🔗 Starting ${methodName} transaction...`);
          appState.isTransactionPending = true;
          
          // Disable all action buttons
          disableAllActionButtons();
          
          showStatus(statusId, '🔐 Confirming transaction...', 'pending');

          // Create contract instance
          const contract = new ethers.Contract(contractAddress, abi, appState.signer);
          
          // Send transaction with gas settings
          console.log(`📝 Sending ${methodName} transaction...`);
          
          const tx = await contract[methodName]({
            gasLimit: 150000, // Set reasonable gas limit
            gasPrice: ethers.utils.parseUnits('1', 'gwei') // Low gas price for testnet
          });

          console.log('✅ Transaction sent:', tx.hash);
          showStatus(statusId, `📡 Transaction sent: ${tx.hash.slice(0,10)}...`, 'pending');

          // Wait for confirmation (with timeout)
          const confirmationPromise = tx.wait();
          const timeoutPromise = new Promise((_, reject) => 
            setTimeout(() => reject(new Error('Transaction timeout')), 30000)
          );

          try {
            const receipt = await Promise.race([confirmationPromise, timeoutPromise]);
            
            if (receipt && receipt.status === 1) {
              console.log('✅ Transaction confirmed:', receipt);
              showStatus(statusId, successMsg, 'success');
              addXP(xpAmount);
              setTimeout(() => hideStatus(statusId), 3000);
            } else {
              throw new Error('Transaction failed');
            }
          } catch (waitError) {
            if (waitError.message === 'Transaction timeout') {
              // Assume success after timeout for better UX
              console.log('⏱️ Transaction timeout, assuming success');
              showStatus(statusId, successMsg, 'success');
              addXP(xpAmount);
              setTimeout(() => hideStatus(statusId), 3000);
            } else {
              throw waitError;
            }
          }

        } catch (error) {
          console.error('❌ Transaction error:', error);
          
          let errorMsg = 'Transaction failed';
          
          if (error.code === 4001 || error.message.includes('user rejected')) {
            errorMsg = 'Transaction cancelled by user';
          } else if (error.message.includes('insufficient funds')) {
            errorMsg = 'Insufficient funds for gas';
          } else if (error.message.includes('network')) {
            errorMsg = 'Network error - please try again';
          }
          
          showStatus(statusId, errorMsg, 'error');
          setTimeout(() => hideStatus(statusId), 5000);
          
        } finally {
          // Always re-enable buttons
          appState.isTransactionPending = false;
          enableAllActionButtons();
        }
      }

      // Disable all action buttons
      function disableAllActionButtons() {
        const buttons = document.querySelectorAll('button');
        buttons.forEach(button => {
          if (!button.id.includes('disconnect') && !button.classList.contains('tab')) {
            button.disabled = true;
            button.dataset.originalText = button.textContent;
          }
        });
      }

      // Enable all action buttons
      function enableAllActionButtons() {
        const buttons = document.querySelectorAll('button');
        buttons.forEach(button => {
          if (!button.id.includes('disconnect') && !button.classList.contains('tab')) {
            button.disabled = false;
            if (button.dataset.originalText) {
              button.textContent = button.dataset.originalText;
              delete button.dataset.originalText;
            }
          }
        });
        
        // Update special buttons
        updateClaimUI();
        if (appState.connected) {
          document.getElementById('slotsButton').textContent = '🎰 Play Slots';
        }
      }

      // Ensure Monad network
      async function ensureMonadNetwork() {
        const MONAD_CHAIN_ID = '0x279F'; // 10143 in hex
        
        try {
          const provider = appState.provider._provider || window.ethereum;
          const chainId = await provider.request({ method: 'eth_chainId' });
          
          console.log('Current chain ID:', chainId);

          if (chainId !== MONAD_CHAIN_ID) {
            console.log('Switching to Monad Testnet...');
            
            try {
              await provider.request({
                method: 'wallet_switchEthereumChain',
                params: [{ chainId: MONAD_CHAIN_ID }],
              });
            } catch (switchError) {
              if (switchError.code === 4902) {
                console.log('Adding Monad Testnet...');
                await provider.request({
                  method: 'wallet_addEthereumChain',
                  params: [{
                    chainId: MONAD_CHAIN_ID,
                    chainName: 'Monad Testnet',
                    nativeCurrency: {
                      name: 'Monad',
                      symbol: 'MONAD',
                      decimals: 18
                    },
                    rpcUrls: ['https://testnet-rpc.monad.xyz'],
                    blockExplorerUrls: ['https://testnet.monadscan.com/']
                  }]
                });
              } else {
                throw switchError;
              }
            }
            
            // Recreate provider after network switch
            appState.provider = new ethers.providers.Web3Provider(provider);
            appState.signer = appState.provider.getSigner();
          }
        } catch (error) {
          console.error('Network error:', error);
          showError('Failed to switch to Monad Testnet');
        }
      }

      // Initialize app
      initApp();
    });
  </script>
</body>
</html>
